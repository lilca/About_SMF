# SMF(Standard Music Files)について

## 1. フォーマットの種類
|種類|説明|
|:-|:-|
|Format 0|1トラック|
|Format 1|マルチトラック対応|
|Format 2|不明|

## 2. チャンク
SMFは、ヘッダチャンクで始まり、それに続く１つ以上のトラックデータで構成される．

### 2.1. Format0の場合
|ファイル|
|:-:|
|ヘッダチャンク|
|トラックチャンク０|

### 2.2. Formatの場合(Nチャンネル使用時)
|ファイル|
|:-:|
|ヘッダチャンク|
|トラックチャンク０|
|トラックチャンク１|
|:|
|トラックチャンクＮ−１|

### 2.3. Format2の場合
不明

## 3. ヘッダチャンク
では、SMFのフォーマット，トラック数や時間単位を設定．長さは固定．

### 3.1. ヘッダチャンクの構成
|名称|バイト数|データ|説明|
|:-|:-:|:-|:-|
|チャンクタイプ|4|4D, 54, 68, 64|テキストデータ"MThd"で固定|
|データ長|4|00, 00, 00, 06|データ長以降の、チャンクの終わりまでのバイト数(6で固定)|
|フォーマット|2|f1, f2|フォーマットを設定|
|トラック数|2|n1, n2|ＳＭＦで使う全トラック数|
|時間単位|2|t1, t2|時間の最小の長さ． 詳細は 3.2. を参照|

### 3.2. 項目の説明
```
・フォーマット(ff,ff):
  Format0なら00,00．Format1なら00,01

・トラック数(n1,n2):
  Format0では、00,01で固定．Format1では最大00,0F

・時間単位(t1,t1):
  最上位ビットが0:
    t1,t2 = 四分音符の分割数
  最上位ビットが1:
    t1 = フレームレート
      -24 (24fps Film)
      -25 (25fps PAL)
      -29 (30fps drop frame SMPTE)
      -30 (30fps non-drop SMPTE(NTSC))
    t2 = フレーム内の分割数

(データは１６進数表記でビックエンディアン)
```

## 4. トラックチャンク
では、演奏を指示するデータや歌詞やテンポなどのデータが格納される．

### 4.1. トラックチャンクの構成
|名称|バイト数|データ|説明|
|:-|:-:|:-|:-|
|チャンクタイプ|4|4D, 54, 72, 6B|テキストデータ"MTrk"で固定|
|データ長|4|00, 00, 00, 06|データ長以降の、チャンクの終わりまでのバイト数|
|Mtrkイベント|N|-|1つ以上のイベント|

### 4.2. Mtrkイベントの構成
|名称|データ|説明|
|デルタタイム|最大4Byte|次のMTrkイベントまでの時間(単位はヘッダーチャンクの時間単位)<br>ゼロの場合、次のイベントは同時に実行される<br>詳細は 4.2.1. を参照|
|イベント||MIDIイベント、SysExイベント、メタイベントのいずれか|


### 4.2.1. デルタタイム
```
各バイトのMSB(第7ビット)は、次の1バイトが出るタイムに含まれるの判定に使われ、このビットは数値には含まれない
  MSB = 0 このバイトまでデルタタイム
  MSB = 1 次のバイトもデルタタイム

(ただし、最大４Byte)
```
```
例).
 7F    = (0)111.1111             = _111.1111           = 127
 81 00 = (1)000.0001 (0)000.0000 = __00.0000 1000.0000 = 128
```

###4.2.2. イベント
「イベント」は、デルタタイムに続いて

次はここからやります


## MIDIイベント
|メッセージ名|データ|説明|
|:--|:--:|:--|
|ノートオフ|8n, kk, vv|nチャンネルで、音階kkを、vvの速さで音を止める|
|ノートオン|9n, kk, vv|nチャンネルで、音階kkを、vvの速さ（＝音量）で音を鳴らす|
|コントロールチェンジ|Bn, cc, dd|nチャンネルで、各種コントローラを制御|
|プログラムチェンジ|Cn, pp|nチャンネルで、音色をppに設定|

n
kk
vv
cc
dd

## SysExイベント

|F0|データ長（可変長）|エクスクルーシブメッセージ|F7|

## メタイベント

|FF|メタイベントタイプ（1byte）|データ長（可変長）|メタデータ|


# キーノート
キーノートは、0から127の番号

    国際式
    キーノート番号 = 12 * (o + 1) + k  ---(a-1)
    440Hz => o = 4, k = 9

    ヤマハ式
    キーノート番号 = 12 * (o + 2) + k ----(a-2)
    440Hz => o = 3, k = 9

o...オクターブ,  k...音階

## 音階(k)
|C|C#|D|D#|E|F|F#|G|G#|A|#A|B|
|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|:--|
|0|1|2|3|4|5|6|7|8|9|10|11|

# コントロールチェンジ
コントロールチェンジは、全部覚えるのは現実的でない。
ので、大事なものだけ。

## 参照
> MIDI 1.0 規格書
> https://amei.or.jp/midistandardcommittee/MIDI1.0.pdf

> SMF(Standard MIDI File)フォーマット解説
> http://maruyama.breadfish.jp/tech/smf/

> SMF(Standard MIDI Files)の構造
> https://sites.google.com/site/yyagisite/material/smfspec

> タイムコードの形式
> https://steinberg.help/cubase_elements_le_ai/v9.5/ja/cubase_nuendo/topics/synchronization/synchronization_timecode_standards_c.html
